<!DOCTYPE html>
<html lang="mn">
<head>
<meta charset="UTF-8">
<title>Waiter</title>
<style>
.low{background:#ffcccc}
</style>
</head>
<body>

<h2>ЗАХИАЛГА</h2>
<select id="table">
<option value="">Ширээ сонго</option>
<option>1</option><option>2</option><option>3</option>
<option>VIP</option><option>Carry</option>
</select>

<div id="menuView"></div>
<h3>Нийт: <span id="total">0</span>₮</h3>
<button onclick="sendOrder()">Хэвлэх</button>

<hr>
<h3>Орлого нэмэх</h3>
<select id="stockCat">
<option>Ус</option><option>Цай</option><option>Ундаа</option>
</select>
<input id="stockName" placeholder="Нэр">
<input type="number" id="stockQty" placeholder="Тоо">
<button onclick="addStock()">Нэмэх</button>

<hr>
<button onclick="settle()">НЭГТГЭЛ ХЭВЛЭХ</button>
<div id="stockView"></div>

<script>
let cart=[];
function fetchMenu(){
  fetch("/api/menu").then(r=>r.json()).then(d=>{
    menuView.innerHTML=d.map(i=>`<button onclick='add("${i.name}",${i.price},${i.cat})'>${i.name}<br>${i.price}₮</button>`).join("");
  });
}
function add(n,p,c){
  let qty = 1;
  cart.push({name:n,price:p,qty:qty,stock:c!=="Хоол"&&c!=="Салат"});
  total.innerText=cart.reduce((s,i)=>s+i.price*i.qty,0);
}

function sendOrder(){
  if(!table.value) return alert("Ширээ сонгоно уу");
  fetch("/api/order",{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({table:table.value,items:cart})
  }).then(r=>r.json()).then(d=>console.log("Bill:",d.billNo));
  cart=[]; total.innerText=0;
  table.value="";
  fetchStock();
}

function fetchStock(){
  fetch("/api/stock").then(r=>r.json()).then(d=>{
    stockView.innerHTML=d.map(i=>`<div class="${i.qty<10?'low':''}">${i.name} | ${i.qty}</div>`).join("");
  });
}
fetchMenu();
fetchStock();

function addStock(){
  fetch("/api/orlogo",{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name:stockName.value,cat:stockCat.value,qty:stockQty.value})
  }).then(()=>fetchStock());
}

function settle(){
  fetch("/api/settlement",{method:"POST"}).then(()=>fetchStock());
}
</script>
</body>
</html>
