<!DOCTYPE html>
<html lang="mn">
<head>
<meta charset="UTF-8">
<title>Saikhan POS ‚Äì WAITER</title>
<style>
body {
  font-family: Arial, Tahoma, "DejaVu Sans", sans-serif;
  margin: 0;
  background: #f5f5f5;
}
header {
  background: #2c7be5;
  color: #fff;
  padding: 12px;
}

/* MENU GRID */
.grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}
.card {
  background: #fff;
  padding: 8px;
  border-radius: 6px;
  text-align: center;
  cursor: pointer;
}
.card.low {
  background: #ffcccc;
}
.card.out {
  background: #e0e0e0;
  color: #888;
  cursor: not-allowed;
}
.card.out b {
  text-decoration: line-through;
}

/* ORDER LIST */
.order-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #fff;
  padding: 8px;
  margin: 6px 0;
  border-radius: 6px;
}
.order-row button {
  padding: 2px 6px;
  margin: 0 2px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.order-row button:hover {
  opacity: 0.8;
}

/* TABLE BUTTONS */
button {
  padding: 6px 10px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
button:active {
  transform: scale(0.97);
}

/* PRINT STYLE */
@media print {
  @page { size: 58mm auto; margin: 0; }
  body * { visibility: hidden; }
  .print-area, .print-area * { visibility: visible; }
  .print-area {
    position: absolute;
    left: 0;
    top: 0;
    width: 58mm;
    font-size: 14px;
    line-height: 1.4;
  }
  .print-area h3 { text-align: center; margin: 4px 0; }
  .print-area hr {
    border: none;
    border-top: 1px dashed #000;
    margin: 6px 0;
  }
}
</style>
</head>
<body>

<header>
  <h2>Saikhan POS ‚Äì WAITER</h2>
  <div id="info">–®–∏—Ä—ç—ç: - | Bill: -</div>
</header>

<h3>ü™ë –®–∏—Ä—ç—ç</h3>
<div id="tables"></div>

<h3>üìã Menu</h3>
<div id="menu" class="grid"></div>

<h3>üìù –ó–∞—Ö–∏–∞–ª–≥–∞</h3>
<div id="order"></div>
<h3>–ù–∏–π—Ç: <span id="total">0</span>‚ÇÆ</h3>
<button onclick="sendOrder()">üñ®Ô∏è –•—ç–≤–ª—ç—Ö (2 —Ö—É–≤—å)</button>

<!-- PRINT AREAS -->
<div id="print-kitchen" class="print-area" style="left:-9999px;"></div>
<div id="print-cash" class="print-area" style="left:-9999px;"></div>

<h3>üìä –ù—ç–≥—Ç–≥—ç–ª —Ö—ç–≤–ª—ç—Ö</h3>
<button onclick="settle()">–ù—ç–≥—Ç–≥—ç–ª —Ö—ç–≤–ª—ç—Ö</button>

<script>
let menu=[], stock=[], order=[], table=null, bill=0;
const info = document.getElementById("info");

// ===== LOAD DATA =====
async function load(){
  menu = await fetch("/api/menu").then(r=>r.json());
  stock = await fetch("/api/stock").then(r=>r.json());
  drawTables(); drawMenu(); drawOrder();
}
load();

// ===== TABLES =====
function drawTables(){
  const tables = document.getElementById("tables");
  tables.innerHTML="";
  ["0","1","2","3","4","5","6","7","8","9","VIP –ù–∞–∞–¥","VIP –¶–∞–∞–¥","–ê–≤—á —è–≤–∞—Ö"].forEach(t=>{
    const b = document.createElement("button");
    b.textContent = t;
    b.onclick = ()=>{table=t; info.innerText=`–®–∏—Ä—ç—ç: ${t} | Bill: ${bill+1}`;};
    tables.appendChild(b);
  });
}

// ===== MENU =====
function drawMenu(){
  const menuDiv = document.getElementById("menu");
  menuDiv.innerHTML="";
  menu.forEach(m=>{
    const s = stock.find(x=>x.name===m.name);
    const q = s ? s.qty : "-";
    const outOfStock = (["–£—Å","–£–Ω–¥–∞–∞","–¶–∞–π"].includes(m.cat) && q === 0);
    const d = document.createElement("div");
    d.className = "card" + (q !== "-" && q < 10 ? " low" : "");
    if(outOfStock) d.classList.add("out");
    d.innerHTML = `<b>${m.name}</b><br>${m.price}‚ÇÆ<br>“Æ–ª–¥:${q}`;
    if(!outOfStock) d.onclick = ()=>addItem(m);
    menuDiv.appendChild(d);
  });
}

// ===== ORDER =====
function addItem(m){
  if(!table){alert("–®–∏—Ä—ç—ç —Å–æ–Ω–≥–æ–Ω–æ —É—É"); return;}
  const s = stock.find(x=>x.name===m.name);
  if(["–£—Å","–£–Ω–¥–∞–∞","–¶–∞–π"].includes(m.cat) && s && s.qty===0){
    alert("“Æ–ª–¥—ç–≥–¥—ç–ª –¥—É—É—Å—Å–∞–Ω —Ç—É–ª –∑–∞—Ö–∏–∞–ª–∞–≥–¥–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π");
    return;
  }
  const i = order.find(x=>x.name===m.name);
  i ? i.qty++ : order.push({name:m.name, price:m.price, qty:1});
  drawOrder();
}

function drawOrder(){
  const d = document.getElementById("order");
  d.innerHTML="";
  let total=0;
  order.forEach((i,idx)=>{
    const sum = i.price*i.qty;
    total += sum;
    const r = document.createElement("div");
    r.className="order-row";
    r.innerHTML = `
      <div><b>${i.name}</b><br>${i.price}‚ÇÆ √ó ${i.qty} = <b>${sum}‚ÇÆ</b></div>
      <div>
        <button onclick="chgQty(${idx},-1)">‚ûñ</button>
        <button onclick="chgQty(${idx},1)">‚ûï</button>
        <button onclick="delItem(${idx})">‚ùå</button>
      </div>
    `;
    d.appendChild(r);
  });
  document.getElementById("total").textContent = total;
}

function chgQty(i,delta){
  order[i].qty += delta;
  if(order[i].qty<=0) order.splice(i,1);
  drawOrder();
}

function delItem(i){
  order.splice(i,1);
  drawOrder();
}

// ===== SEND ORDER =====
async function sendOrder(){
  if(!table || order.length===0){
    alert("–®–∏—Ä—ç—ç –±–æ–ª–æ–Ω –∑–∞—Ö–∏–∞–ª–≥–∞ —Å–æ–Ω–≥–æ–Ω–æ —É—É");
    return;
  }
  const now = new Date().toLocaleString();

  // ===== KITCHEN PRINT =====
  let kitchenHTML = `<div class="print-area">
    <h3>üç≥ –ì–ê–õ –¢–û–ì–û–û</h3>
    <p>–®–∏—Ä—ç—ç: ${table}</p><hr>`;
  order.forEach(i=>{
    kitchenHTML += `<p>${i.name} √ó ${i.qty}</p>`;
  });
  kitchenHTML += `<hr><p>${now}</p></div>`;
  const kDiv = document.getElementById("print-kitchen");
  kDiv.innerHTML = kitchenHTML;
  kDiv.style.left="0";
  window.print();
  kDiv.style.left="-9999px";

  // ===== CASH PRINT (400ms delay) =====
  setTimeout(()=>{
    let totalSum=0;
    let cashHTML = `<div class="print-area">
      <h3>üí∞ –ö–ê–°–°</h3>
      <p>–®–∏—Ä—ç—ç: ${table}</p><hr>`;
    order.forEach(i=>{
      const sum = i.price*i.qty;
      totalSum += sum;
      cashHTML += `<p>${i.name}<br>${i.qty} √ó ${i.price}‚ÇÆ = ${sum}‚ÇÆ</p>`;
    });
    cashHTML += `<hr><b>–ù–ò–ô–¢: ${totalSum}‚ÇÆ</b><p>${now}</p></div>`;
    const cDiv = document.getElementById("print-cash");
    cDiv.innerHTML = cashHTML;
    cDiv.style.left="0";
    window.print();
    cDiv.style.left="-9999px";

    // ===== SAVE ORDER =====
    fetch("/api/order",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({table, items:order, total:totalSum, time: now})
    });

    order = [];
    table = null;
    drawOrder();
    drawTables();
    alert("‚úî –ì–∞–ª —Ç–æ–≥–æ–æ + –ö–∞—Å—Å —Ö—ç–≤–ª—ç–≥–¥–ª—ç—ç");
  }, 400);
}

// ===== SETTLEMENT =====
async function settle(){
  await fetch("/api/settlement",{method:"POST"});
  alert("–ù—ç–≥—Ç–≥—ç–ª —Ö—ç–≤–ª—ç–≥–¥–ª—ç—ç");
}
</script>
</body>
</html>
