<!DOCTYPE html>
<html lang="mn">
<head>
<meta charset="UTF-8">
<title>Saikhan POS – Waiter</title>
<style>
body{font-family:Arial;background:#f5f5f5;margin:0;padding:15px}
button{padding:6px;margin:2px;border:none;border-radius:6px;cursor:pointer}
.low{background:#ffcccc}
table{width:100%;border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #ddd;padding:6px;text-align:left}
</style>
</head>
<body>

<h2>WAITER</h2>
<select id="table">
<option value="">Ширээ сонгоно уу</option>
<option>0</option><option>1</option><option>2</option>
<option>3</option><option>4</option><option>5</option>
<option>6</option><option>7</option><option>8</option><option>9</option>
<option>VIP-1</option><option>VIP-2</option>
<option>Carry</option>
</select>

<h3>Menu</h3>
<div id="menu"></div>

<h3>Захиалга</h3>
<div id="cart"></div>
<button onclick="send()">Хэвлэх</button>

<h3>Нэгтгэл</h3>
<button onclick="loadSet()">Шинэчлэх</button>
<div id="set"></div>

<script>
let CART=[];

async function load(){
  const res = await fetch("/api/menu");
  const menu = await res.json();
  menu.sort((a,b)=>a.cat.localeCompare(b.cat));
  menuDiv="";
  let col=0;
  menu.forEach(m=>{
    if(col%4===0) menuDiv+="<br>";
    menuDiv+=`<button onclick='add("${m.name}",${m.price},"${m.cat}")'>${m.name} ${m.price}₮</button> `;
    col++;
  });
  menu.innerHTML=menuDiv;
});

async function addMenuItem(){
  const res = await fetch("/api/menu");
  return await res.json();
}

function add(n,p,c){
  const x=CART.find(i=>i.name===n);
  if(x) x.qty++; else CART.push({name:n,price:p,qty:1,cat:c});
  draw();
}

function addQty(n){ const x=CART.find(i=>i.name===n); if(x)x.qty++; draw();}
function subQty(n){ const x=CART.find(i=>i.name===n); if(x&&x.qty>1)x.qty--; draw();}
function draw(){ cart.innerHTML=CART.map(i=>`${i.name} <button onclick='subQty("${i.name}")'>-</button> ${i.qty} <button onclick='addQty("${i.name}")'>+</button>`).join("<br>"); }

async function send(){
  if(!table.value){alert("Ширээ сонгоно уу"); return;}
  const r=await fetch("/api/order",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({table:table.value,items:CART})});
  const d=await r.json();
  print(CART,table.value,d.bill);
  CART=[]; draw(); loadSet();
}

function print(items,table,bill){
  let t=0;
  let k=`<h3>ГАЛ ТОГОО</h3>Ширээ:${table}<hr>`;
  items.filter(i=>i.cat==="food"||i.cat==="salad").forEach(i=>k+=`${i.name} x${i.qty}<br>`);
  const w1=window.open(""); w1.document.write(k); w1.print(); w1.close();

  let c=`<h3>КАСС</h3>Ширээ:${table}<br>Билл:${bill}<hr>`;
  items.forEach(i=>{ c+=`${i.name} x${i.qty} = ${i.price*i.qty}₮<br>`; t+=i.price*i.qty; });
  c+=`<hr>НИЙТ:${t}₮`;
  const w2=window.open(""); w2.document.write(c); w2.print(); w2.close();
}

async function loadSet(){
  const s=await fetch("/api/settlements").then(r=>r.json());
  set.innerHTML = s.map(set=>{
    let h=`<b>${set.date}</b><br>`;
    set.orders.forEach(o=>{ o.items.forEach(i=>h+=`${i.name} x${i.qty} = ${i.price*i.qty}₮<br>`) });
    return h+"<hr>";
  }).join("");
}

load();
</script>
</body>
</html>
