<!DOCTYPE html>
<html lang="mn">
<head>
<meta charset="UTF-8">
<title>Saikhan POS ‚Äì Waiter</title>
<style>
body{font-family:Arial;margin:0;background:#f5f5f5}
header{background:#2c7be5;color:#fff;padding:12px}
header h2{margin:0}
section{padding:10px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.card{background:#fff;padding:8px;border-radius:6px;cursor:pointer;text-align:center}
.card.low{background:#ffcccc}
.order-item{display:flex;justify-content:space-between;margin:5px 0}
input{width:60px;padding:4px;margin-left:5px}
button{padding:5px 8px;margin-left:5px;border:none;border-radius:4px;cursor:pointer}
</style>
</head>

<body>

<header>
<h2>WAITER</h2>
<div id="info">–®–∏—Ä—ç—ç: -</div>
</header>

<section>
<h3>ü™ë –®–∏—Ä—ç—ç</h3>
<div id="tables"></div>
</section>

<section>
<h3>üìã Menu</h3>
<div id="menu" class="grid"></div>
</section>

<section>
<h3>üìù –ó–∞—Ö–∏–∞–ª–≥–∞</h3>
<div id="order"></div>
<h3>–ù–∏–π—Ç: <span id="total">0</span>‚ÇÆ</h3>
<button onclick="sendOrder()">–•—ç–≤–ª—ç—Ö</button>
</section>

<section>
<h3>üì¶ –û—Ä–ª–æ–≥–æ (–£—Å / –£–Ω–¥–∞–∞ / –¶–∞–π)</h3>
<div id="stock"></div>
</section>

<section>
<h3>üìä –ù—ç–≥—Ç–≥—ç–ª</h3>
<table>
<thead>
<tr><th>–ù—ç—Ä</th><th>–¢–æ–æ</th><th>–ù–∏–π—Ç “Ø–Ω—ç</th></tr>
</thead>
<tbody id="settleBody"></tbody>
</table>
</section>

<script>
let menu=[], stock=[];
let order=[], table=null;

/* ===== LOAD ===== */
async function load(){
  menu = await fetch("/api/menu").then(r=>r.json());
  stock = await fetch("/api/stock").then(r=>r.json());
  drawTables();
  drawMenu();
  drawStock();
  loadSettlement();
}
load();

/* ===== TABLE ===== */
function drawTables(){
  const d=document.getElementById("tables");
  d.innerHTML="";
  [...Array(10).keys()].forEach(i=>{
    const b=document.createElement("button");
    b.textContent="–®–∏—Ä—ç—ç "+i;
    b.onclick=()=>{table="–®–∏—Ä—ç—ç "+i; info();};
    d.appendChild(b);
  });
}
function info(){document.getElementById("info").textContent="–®–∏—Ä—ç—ç: "+table;}

/* ===== MENU ===== */
function drawMenu(){
  const d=document.getElementById("menu");
  d.innerHTML="";
  menu.forEach(m=>{
    const s = stock.find(x=>x.name===m.name);
    const qty = s ? s.qty : "-";
    const c=document.createElement("div");
    c.className="card"+(qty!=="-" && qty<10?" low":"");
    c.innerHTML=`<b>${m.name}</b><br>${m.price}‚ÇÆ<br>“Æ–ª–¥:${qty}`;
    c.onclick=()=>add(m);
    d.appendChild(c);
  });
}

/* ===== ORDER ===== */
function add(m){
  let i=order.find(x=>x.name===m.name);
  if(i) i.qty++;
  else order.push({name:m.name,price:m.price,qty:1});
  drawOrder();
}
function drawOrder(){
  const d=document.getElementById("order");
  d.innerHTML="";
  let t=0;
  order.forEach(i=>{
    t+=i.price*i.qty;
    const r=document.createElement("div");
    r.className="order-item";
    r.innerHTML=`${i.name} x<input type="number" value="${i.qty}" min="1" onchange="changeQty('${i.name}',this.value)"> = ${i.price*i.qty}‚ÇÆ`;
    d.appendChild(r);
  });
  document.getElementById("total").textContent=t;
}
function changeQty(name,val){
  let i=order.find(x=>x.name===name);
  if(i) i.qty=Number(val);
  drawOrder();
}

/* ===== SEND ===== */
async function sendOrder(){
  if(!table){alert("–®–∏—Ä—ç—ç —Å–æ–Ω–≥–æ–Ω–æ —É—É"); return;}
  await fetch("/api/order",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({table,items:order})
  });
  order=[];
  drawOrder();
  load();
  alert("–•—ç–≤–ª—ç–≥–¥–ª—ç—ç");
}

/* ===== STOCK / ORLOGO ===== */
function drawStock(){
  const d=document.getElementById("stock");
  d.innerHTML="";
  stock.forEach(s=>{
    d.innerHTML+=`
      ${s.name} (“Æ–ª–¥:${s.qty})
      <input id="q_${s.name}" type="number" min="0">
      <button onclick="orlogo('${s.name}')">–ù—ç–º—ç—Ö</button><br>
    `;
  });
}
async function orlogo(n){
  const q=+document.getElementById("q_"+n).value;
  if(q<=0) return;
  await fetch("/api/orlogo",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name:n,qty:q})
  });
  document.getElementById("q_"+n).value="";
  load();
}

/* ===== SETTLEMENT ===== */
async function loadSettlement(){
  const res = await fetch("/api/settlements");
  const data = await res.json();
  const map={};
  data.forEach(s=>{
    s.orders.forEach(o=>{
      o.items.forEach(i=>{
        if(!map[i.name]) map[i.name]={qty:0,sum:0};
        map[i.name].qty+=i.qty;
        map[i.name].sum+=i.qty*i.price;
      });
    });
  });
  const tbody=document.getElementById("settleBody");
  tbody.innerHTML="";
  Object.keys(map).forEach(n=>{
    tbody.innerHTML+=`
      <tr>
        <td>${n}</td>
        <td>${map[n].qty}</td>
        <td>${map[n].sum}‚ÇÆ</td>
      </tr>
    `;
  });
}
</script>

</body>
</html>
